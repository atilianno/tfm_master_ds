---
title: "TFM_E2_Grupo02"
output: html_document
date: "2023-06-08"
---
  
```{r}
library(dplyr)
library(factoextra)
library(ggplot2)
library(cluster)
library(tidyverse)
library(ggcorrplot)
library(writexl)
library(openxlsx)
library(PerformanceAnalytics)
library(corrplot)
```


```{r}
#cargamos los datos con las variables que nos interesan
#df1 = data.frame(read.csv2('C:/Users/linfante/OneDrive/Documentos/MasterBigData/TFM/tfm_master_ds/1 - BackEnd/Datos/alimentos v3.csv', sep=','))
#df2 = data.frame(read.csv2('C:/Users/linfante/OneDrive/Documentos/MasterBigData/TFM/tfm_master_ds/1 - BackEnd/Datos/alimentos_vegan.csv', sep=','))
df = data.frame(read.csv2('C:/Users/linfante/OneDrive/Documentos/MasterBigData/TFM/tfm_master_ds/1 - BackEnd/Datos/alimentos v4.csv', sep=','))

```


```{r}
#df <- df[,c("PRODUCT_NAME","PROTEINS_100G","CARBOHYDRATES_100G","FAT_100G","FIBER_100G","SALT_100G","SATURATED_FAT_100G","SUGARS_100G")]
df <- df[,c("PRODUCT_NAME","PROTEINS_100G","CARBOHYDRATES_100G","FAT_100G")]
```


```{r}
PRODUCT_NAME <- df[,1]
 
# Filtrar las columnas que contienen el texto "_100G"
#columnas_filtradas <- grep("_100G", colnames(df))
#df <- df[, columnas_filtradas]
#df <- cbind(PRODUCT_NAME,df)

#Convertir a numerico todo
df_nuevo <- df %>%
  mutate(across(where(is.character), type.convert, as.is = TRUE)) %>%
  select_if(is.numeric)

total <- as.data.frame(colSums(df_nuevo))
totalc <- as.data.frame(rowSums(df_nuevo))
```

```{r}
totales <- colSums(df_nuevo)

# Seleccionar las columnas con un total mayor o igual a 5
#columnas_a_mantener <- totales >= 10000

# Eliminar las columnas con un total inferior a 30
#df_nuevo <- df_nuevo[, columnas_a_mantener]
PRODUCT_NAME <- df[,1]
df_nuevo <- cbind(PRODUCT_NAME,df_nuevo)

```


```{r}
#elimina vectores fila nulos 
df_nuevo$suma <- rowSums(df_nuevo[, c("PROTEINS_100G","CARBOHYDRATES_100G","FAT_100G")])
df_nuevo <- subset(df_nuevo, !(suma == 0))
df_nuevo <- df_nuevo[,c("PRODUCT_NAME","PROTEINS_100G","CARBOHYDRATES_100G","FAT_100G")]
df_nuevo <- na.omit(df_nuevo)

```


```{r}
#filtros negativos
# Crear un vector con las palabras a buscar
palabras_a_eliminar <- c("SALSA DE SOJA","SAUCE SOJA", "SAUCE SOJA","BEBIDA DE SOJA", "YAOURT SOJA","YOGURT DE SOJA","CHOCOLAT","ARROZ Y SOJA","LECHE","MOUSSE","MILK","ACEITE","DESSERT","PAN SOJA","BOISSON SOJA", "GLACE","ML","SAUCE DE SOJA","SAUCE","SALSA","BIBEDA DE SOJA","LAIT SOJA","VIVESOY SOJA","LAIT DE SOJA","YAOURT","POSTRE","MUESLI","YOGUR","BEBIDA","MARGARINA","VINAIGRETTE","DRINK","SAUCE","BATIDO","LAIT","MAYONNAISE","CAFE","VANILLE","NATA","YOGURT")

# Crear una función que verifica si alguna de las palabras está presente en el texto
verificar_palabras <- function(texto, palabras) {
  sapply(palabras, function(palabra) grepl(palabra, texto))
}
# Identificar las filas que contienen alguna de las palabras a eliminar
filas_a_eliminar <- apply(df_nuevo, 1, function(row) any(verificar_palabras(row["PRODUCT_NAME"], palabras_a_eliminar)))

# Eliminar las filas identificadas del dataframe original
df_nuevo1 <- df_nuevo[!filas_a_eliminar, ]
#df_nuevo2 <- df_nuevo1[,-1]

#Elimino los faltantes
df_nuevo1 <- df_nuevo1[complete.cases(df_nuevo1), ]

```

```{r}
df_soja <- subset(df_nuevo1, grepl("soja", PRODUCT_NAME, ignore.case = TRUE)) ## Registros que contienen la palabra "soja"
df_seitan <- subset(df_nuevo1, grepl("seitan", PRODUCT_NAME, ignore.case = TRUE)) ## Registros que contienen la palabra "seitan"
df_tofu <- subset(df_nuevo1, grepl("tofu", PRODUCT_NAME, ignore.case = TRUE)) ## Registros que contienen la palabra "tofu"
df_tofu <- na.omit(df_tofu)

```


```{r}
# Definir la función para eliminar valores atípicos basados en desviación estándar
remove_outliers <- function(data, column, sd_threshold = 2) {
  data[abs(scale(data[[column]])) < sd_threshold, ]
}
# Eliminar valores atípicos en columna1 utilizando desviación estándar
df_soja <- remove_outliers(df_soja, "PROTEINS_100G")
df_soja <- remove_outliers(df_soja, "CARBOHYDRATES_100G")
df_soja <- remove_outliers(df_soja, "FAT_100G")
#df_soja <- remove_outliers(df_soja, "SUGARS_100G")

# Eliminar valores atípicos en columna1 utilizando desviación estándar
df_seitan <- remove_outliers(df_seitan, "PROTEINS_100G")
df_seitan <- remove_outliers(df_seitan, "CARBOHYDRATES_100G")
df_seitan <- remove_outliers(df_seitan, "FAT_100G")
#df_seitan <- remove_outliers(df_seitan, "SUGARS_100G")

# Eliminar valores atípicos en columna1 utilizando desviación estándar
df_tofu <- remove_outliers(df_tofu, "PROTEINS_100G")
df_tofu <- remove_outliers(df_tofu, "CARBOHYDRATES_100G")
df_tofu <- remove_outliers(df_tofu, "FAT_100G")
#df_tofu <- remove_outliers(df_tofu, "SUGARS_100G")
```

#### SOja #####

```{r}
summary(df_soja)

```

```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(df_soja, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(df_soja[columnas_cuantitativas])) {
  plot_data <- df_soja[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```

```{r}
s_soja <- scale(df_soja[,-1])
s_soja1 <- as.data.frame(s_soja)
summary(s_soja)
```
```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(s_soja1, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(s_soja1[columnas_cuantitativas])) {
  plot_data <- s_soja1[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```

```{r}
#total de cluster óptimos
elbow <- fviz_nbclust(x = s_soja, FUNcluster = kmeans, method = "wss", k.max = 15, 
             diss = get_dist(s_soja, method = "euclidean"), nstart = 25)
print(elbow)

#Clustering K-means
set.seed(123)
km_clusters <- kmeans(x=s_soja,centers=4,nstart=25)
fviz_cluster(object=km_clusters,data=s_soja,show.clust.cent = TRUE,
             ellipse.type="euclid",star.plot=TRUE,repel=TRUE,
             pointsize=0.5,outlier.color="darkred") +
  labs(title ="Resultados clustering K-means") +
  theme_bw() +
  theme(legend.position = "none")

#Dedrograma
set.seed(101)
heculidea <- hclust(d = dist(x = s_soja, method = "euclidean"),
                    method = "complete")

fviz_dend(x=heculidea,cex=0.5,main = "Linkage completo",
               sub="Distancia euclídea")+
        theme(plot.title = element_text(hjust=0.5,size=15))

#Resultados clustering K-means
require(cluster)
pam.res <- pam(s_soja, 4)
# Visualización
fviz_cluster(pam.res, geom = "point", ellipse.type = "norm",
             show.clust.cent = TRUE,star.plot = TRUE)+
  labs(title = "Resultados clustering K-means")+ theme_bw()

hc_euclidea_av <- hclust(d = dist(x = datj, method = "euclidean"),
                         method = "average")
```
Con esta imagen se evidencia que hay cierto grado de conflicto entre los clusters, ya que tienen cierta área solapada entre ambos. Estas representaciones mezclan cluster y PCA, pero no indican el grado de representación de cada variable en cada uno de los componentes.


### SEITAN####

```{r}
summary(df_seitan)

```

```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(df_seitan, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(df_seitan[columnas_cuantitativas])) {
  plot_data <- df_seitan[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```

```{r}
s_seitan <- scale(df_seitan[,-1])
s_seitan1 <- as.data.frame(s_seitan)
summary(s_seitan)
```
#Datos normalizados para el Seitán
```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(s_seitan1, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(s_seitan1[columnas_cuantitativas])) {
  plot_data <- s_seitan1[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```


```{r}
s_seitan <- scale(df_seitan[,-1])

# total de cluster óptimos
elbow <- fviz_nbclust(x = s_seitan, FUNcluster = kmeans, method = "wss", k.max = 15, 
             diss = get_dist(s_seitan, method = "euclidean"), nstart = 25)
print(elbow)

set.seed(123)
km_clusters <- kmeans(x=s_seitan,centers=4,nstart=25)
fviz_cluster(object=km_clusters,data=s_seitan,show.clust.cent = TRUE,
             ellipse.type="euclid",star.plot=TRUE,repel=TRUE,
             pointsize=0.5,outlier.color="darkred") +
  labs(title ="Resultados clustering K-means") +
  theme_bw() +
  theme(legend.position = "none")


set.seed(101)
heculidea <- hclust(d = dist(x = s_seitan, method = "euclidean"),
                    method = "complete")

fviz_dend(x=heculidea,cex=0.5,main = "Linkage completo",
               sub="Distancia euclídea")+
        theme(plot.title = element_text(hjust=0.5,size=15))
require(cluster)

pam.res <- pam(s_seitan, 4)
# Visualización
fviz_cluster(pam.res, geom = "point", ellipse.type = "norm",
             show.clust.cent = TRUE,star.plot = TRUE)+
  labs(title = "Resultados clustering K-means")+ theme_bw()
```
##### TOfu #####
```{r}
summary(df_tofu)

```


```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(df_tofu, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(df_tofu[columnas_cuantitativas])) {
  plot_data <- df_tofu[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```

```{r}
s_tofu <- scale(df_tofu[,-1])
s_tofu1 <- as.data.frame(s_tofu)
summary(s_tofu)
```
#Datos normalizados para el Tofu
```{r}
# Obtener las columnas cuantitativas del dataframe
columnas_cuantitativas <- sapply(s_tofu1, is.numeric)

# Crear un histograma para cada columna cuantitativa
for (columna in names(s_tofu1[columnas_cuantitativas])) {
  plot_data <- s_tofu1[, columna]
  p <- ggplot(data.frame(x = plot_data), aes(x)) +
    geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
    labs(title = paste("Histograma de", columna),
         x = columna,
         y = "Frecuencia")
  
  print(p)
}
```




```{r}
s_tofu <- scale(df_tofu[,-1])

# total de cluster óptimos
elbow <- fviz_nbclust(x = s_tofu, FUNcluster = kmeans, method = "wss", k.max = 15, 
             diss = get_dist(s_tofu, method = "euclidean"), nstart = 25)
print(elbow)

set.seed(123)
km_clusters <- kmeans(x=s_tofu,centers=4,nstart=25)
fviz_cluster(object=km_clusters,data=s_tofu,show.clust.cent = TRUE,
             ellipse.type="euclid",star.plot=TRUE,repel=TRUE,
             pointsize=0.5,outlier.color="darkred") +
  labs(title ="Resultados clustering K-means") +
  theme_bw() +
  theme(legend.position = "none")


set.seed(101)
heculidea <- hclust(d = dist(x = s_tofu, method = "euclidean"),
                    method = "complete")

fviz_dend(x=heculidea,cex=0.5,main = "Linkage completo",
               sub="Distancia euclídea")+
        theme(plot.title = element_text(hjust=0.5,size=15))
require(cluster)

pam.res <- pam(s_tofu, 4)
# Visualización
fviz_cluster(pam.res, geom = "point", ellipse.type = "norm",
             show.clust.cent = TRUE,star.plot = TRUE)+
  labs(title = "Resultados clustering K-means")+ theme_bw()

```

# Método no jerárquico CLARA basado en simulación y muestreo

# Soja 

```{r}
clara_clusters <- clara(x = scale(df_soja[,-1]), k = 4, metric = "manhattan", stand = TRUE,
                        samples = 60, pamLike = TRUE)
clara_clusters$sample
clara_clusters$medoids
clara_clusters$i.med
clara_clusters$clustering
table(clara_clusters$clustering)
fviz_cluster(object = clara_clusters, ellipse.type = "t", geom = "point",
             pointsize = 1.5) +  theme_bw() +
  labs(title = "Resultados clustering CLARA") +
  theme(legend.position = "none")
```
# Seitán
```{r}
clara_clusters <- clara(x = scale(df_seitan[,-1]), k = 3, metric = "manhattan", stand = TRUE,
                        samples = 60, pamLike = TRUE)
clara_clusters$sample
clara_clusters$medoids
clara_clusters$i.med
clara_clusters$clustering
table(clara_clusters$clustering)
fviz_cluster(object = clara_clusters, ellipse.type = "t", geom = "point",
             pointsize = 1.5) +  theme_bw() +
  labs(title = "Resultados clustering CLARA") +
  theme(legend.position = "none")
```

```{r}
df_tofu <- na.omit(df_tofu)


clara_clusters <- clara(x = scale(df_tofu[,-1]), k = 3, metric = "manhattan", stand = TRUE,
                        samples = 60, pamLike = TRUE)
clara_clusters$sample
clara_clusters$medoids
clara_clusters$i.med
clara_clusters$clustering
table(clara_clusters$clustering)
fviz_cluster(object = clara_clusters, ellipse.type = "t", geom = "point",
             pointsize = 1.5) +  theme_bw() +
  labs(title = "Resultados clustering CLARA") +
  theme(legend.position = "none")
```
